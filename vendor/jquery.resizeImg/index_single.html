<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>自动缩图</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="windows-Target" content="_top" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" media="screen" type="text/css" href="bootstrap.css" />
<script src="jquery.js" type="application/javascript"></script>
<body>
<div class="container">
    <div class="card">
        <div class="card-header p-2 bg-info">
            <input id="file" type="file" accept="image/*" capture />
        </div>
        <div class="card-img p-3">
            <div class="input-group mb-3" style="max-width:450px;">
                <div class="input-group-prepend">
                    <label class="input-group-text">缩图模式</label>
                </div>
                <select class="custom-select" id="mode"><option>按宽度</option><option>按比例</option><option>按大小（相对于原精度）</option></select>
                <div>
                    <select class="custom-select rounded-0" id="mode_0"><option value="800">800px</option><option value="600" selected>600px</option><option value="400">400px</option></select>
                    <select class="custom-select rounded-0 d-none" id="mode_1"><option value="1">原大</option><option value="0.5" selected>1/2</option><option value="0.25">1/4</option><option value="0.125">1/8</option></select>
                    <select class="custom-select rounded-0 d-none" id="mode_2"><option value="100">100KB</option><option value="200" selected>200KB</option><option value="500">500KB</option></select>
                </div>
                <div class="input-group-append">
                    <select class="custom-select rounded-0" id="format"><option>JPG-10</option><option selected>JPG-8</option><option>JPG-6</option><option>PNG（无压缩）</option></select>
                </div>
            </div>
            <textarea class="custom-select w-100 d-none" id="img_data"></textarea>
            <img id="showImg" src="" />
        </div>
    </div>
</div>
</body>
<script type="application/javascript">
$("#file").change(function(){
    getImg(this.files[0], $("#format").get(0).selectedIndex);
});

$("select").change(function() {
    getImg($("#file").get(0).files[0], $("#format").get(0).selectedIndex);
});

$("#mode").change(function(){
    $(this).next().find("select").addClass("d-none");
    $("#mode_"+this.selectedIndex).removeClass("d-none");
});

function getPara(width, height, size) {
    var result = {width:width,height:height,rate:1};
    var val = 0;
    switch ($("#mode").get(0).selectedIndex) {
        case 0:
            val = $("#mode_0").val();
            result.rate = val/width;
            result.width = val;
            result.height *= result.rate;
            break;
        case 1:
            val = $("#mode_1").val();
            result.rate = val;
            result.width *= val;
            result.height *= val;
            break;
        case 2:
            val = $("#mode_2").val() * 1024;
            result.rate = Math.sqrt(size / val);
            result.width = Math.ceil(width / result.rate);
            result.height = Math.ceil(height / result.rate);
            break;
    }
    return result;
}

function getImg(o, t) {
    if(typeof(o)=='undefined') return;
    getOrientation(o, function(orientation) {
        var reader  = new FileReader();
        var img = new Image();
        img.onload = function() {
            var para = getPara(this.width, this.height, this.src.length);
            var w = para.width;
            var h = para.height;
            var rate = para.rate;

            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext('2d');
            if(orientation<6) {
                canvas.width = w;
                canvas.height = h;
            } else {
                canvas.width = h;
                canvas.height = w;
            }
            switch(orientation) {
                case 2:
                    // horizontal flip
                    ctx.translate(w, 0);
                    ctx.scale(-1, 1);
                    break;
                case 3:
                    // 180 rotate left
                    ctx.translate(w, h);
                    ctx.rotate(Math.PI);
                    break;
                case 4:
                    // vertical flip
                    ctx.translate(0, h);
                    ctx.scale(1, -1);
                    break;
                case 5:
                    // vertical flip + 90 rotate right
                    ctx.rotate(0.5 * Math.PI);
                    ctx.scale(1, -1);
                    break;
                case 6:
                    // 90 rotate right
                    ctx.rotate(0.5 * Math.PI);
                    ctx.translate(0, -h);
                    break;
                case 7:
                    // horizontal flip + 90 rotate right
                    ctx.rotate(0.5 * Math.PI);
                    ctx.translate(w, -h);
                    ctx.scale(-1, 1);
                    break;
                case 8:
                    // 90 rotate left
                    ctx.rotate(-0.5 * Math.PI);
                    ctx.translate(-w, 0);
                    break;
                default:
                    console.log(orientation);
            }
            ctx.drawImage(this, 0, 0, w, h);
            this.onload = null;
            console.log(t);
            switch (t) {
                case 0:
                    this.src = canvas.toDataURL("image/jpeg", 1);
                    break;
                case 1:
                    this.src = canvas.toDataURL("image/jpeg", 0.8);
                    break;
                case 2:
                    this.src = canvas.toDataURL("image/jpeg", 0.6);
                    break;
                case 3:
                    this.src = canvas.toDataURL("image/png");
                    break;
                default:
                    this.src = canvas.toDataURL("image/jpeg", 0.8);
            }
            $("#showImg").attr('src', this.src);
            $("#img_data").removeClass("d-none").val(this.src.replace(/^.+base64,/, "")).css("height",100);

        }
        reader.addEventListener("load", function () {
            img.src = reader.result;
        }, false);
        reader.readAsDataURL(o);
    });
}

function getOrientation(file, callback) {
    var reader = new FileReader();
    reader.onload = function(e) {
        var view = new DataView(e.target.result);
        if (view.getUint16(0, false) != 0xFFD8) {
            return callback(-2);
        }
        var length = view.byteLength, offset = 2;
        while (offset < length) {
            if (view.getUint16(offset+2, false) <= 8) return callback(-1);
            var marker = view.getUint16(offset, false);
            offset += 2;
            if (marker == 0xFFE1) {
                if (view.getUint32(offset += 2, false) != 0x45786966) {
                    return callback(-1);
                }
                var little = view.getUint16(offset += 6, false) == 0x4949;
                offset += view.getUint32(offset + 4, little);
                var tags = view.getUint16(offset, little);
                offset += 2;
                for (var i = 0; i < tags; i++) {
                    if (view.getUint16(offset + (i * 12), little) == 0x0112) {
                        return callback(view.getUint16(offset + (i * 12) + 8, little));
                    }
                }
            } else if ((marker & 0xFF00) != 0xFF00) {
                break;
            } else {
                offset += view.getUint16(offset, false);
            }
        }
        return callback(-1);
    };
    reader.readAsArrayBuffer(file);
}
</script>
</html>
